/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*global tinymce:true */

tinymce.PluginManager.add('imagegrid', function (editor, url) {

    var colRegex = /(\d)c/i;
    var rowRegex = /(\d)r/i;
    var lRegex = /(\d)(r|c)/gi;

    var layouts = [
        { type: "2c1r", text: "2 cols, 1 row", },
        { type: "3c", text: "3 cols", },
        { type: "1r2c", text: "1 row, 2 cols", },
        { type: "4c", text: "4 cols", }
    ];

    var img = '<img src="/image.axd?picture=/select-image.png" style="width:100%;height:100%;" alt="select image" />';

    //generates the image grid inside the editor's content
    function imagegrid(e) {
        
        var ctr = e.control;
        var stt = ctr.settings;
        var type = stt.layout;
        var layout = type.match(lRegex);

        var newHtml = "";

        for (var i = 0; i < layout.length; i++) {
            var item = layout[i];

            //rows
            if (item.match(/r$/i)) {
                var nrows = item.match(rowRegex);
                for (var x = 0; x < nrows[1]; x++) { newHtml += '<div class="pure-u-1">' + img + '</div>'; }
            }

            //cols
            if (item.match(/c$/i)) {
                var ncols = item.match(colRegex);
                newHtml += '<div class="pure-g">';
                for (var x = 0; x < ncols[1]; x++) { newHtml += '<div class="pure-u-1-' + ncols[1] + '">' + img + '</div>'; }
                newHtml += '</div>';
            }
        }

        //html inside a paragraph
        newHtml = "<p>" + newHtml + "</p>";

        // get hold on TinyMce editor and inject link
        top.tinymce.activeEditor.insertContent(newHtml);
    }

    //list of submenus for this plugin
    function submenus() {
        //new array
        var items = [];

        for (var i = 0; i < layouts.length; i++) {
            var layout = layouts[i];
            var item = { text: layout.text, context: "imagegrid", layout: layout.type, onclick: imagegrid, };
            //adding the button to the html layout
            items.push(item);
        }

        return items;
    }

    // Inside plugin
    editor.addMenuItem('imagegrid', {
        text: "Image grid",
        icon: "image",
        menu: submenus(),
    });
    
});
